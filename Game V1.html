<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>АгнияКомбат27</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tg-theme-bg-color: #6a11cb;
            --tg-theme-text-color: #ffffff;
            --tg-theme-button-color: #ff6b6b;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: rgba(255, 255, 255, 0.1);
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #2575fc;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--tg-theme-bg-color, #6a11cb) 0%, var(--tg-theme-link-color, #2575fc) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--tg-theme-text-color, #ffffff);
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        .container {
            text-align: center;
            background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(12px);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(0deg);
            z-index: -1;
        }

        .title {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            color: var(--tg-theme-text-color, #ffffff);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            margin-bottom: 30px;
            letter-spacing: 2px;
            position: relative;
            display: inline-block;
            animation: titleGlow 2s infinite alternate;
        }

        @keyframes titleGlow {
            0% {
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4), 0 0 0 rgba(255, 255, 255, 0.5);
            }
            100% {
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.8);
            }
        }

        .counter {
            font-size: 3rem;
            color: var(--tg-theme-text-color, #ffffff);
            margin: 30px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .click-button {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--tg-theme-button-color, #ff6b6b), #ff8e8e);
            border: none;
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 1.6rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .click-button:hover {
            transform: scale(1.08);
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.7);
        }

        .click-button:active {
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .click-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .click-button:hover::before {
            opacity: 1;
        }

        .message {
            font-size: 1.4rem;
            margin: 20px 0;
            min-height: 40px;
            color: #ffeb3b;
            text-shadow: 0 0 5px rgba(255, 235, 59, 0.7);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .pulse {
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 15px 30px rgba(255, 107, 107, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            }
        }

        .floating {
            position: absolute;
            animation: float 3s ease-in-out forwards;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        @keyframes float {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }

        .achievement {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 1000;
        }

        .achievement.show {
            opacity: 1;
        }

        .upgrades {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .upgrade {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .upgrade:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .upgrade:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .theme-selector {
            margin-top: 20px;
        }

        .theme-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .auto-clicker {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .settings-panel {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(45deg);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--tg-theme-button-color, #ff6b6b), #ff8e8e);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--tg-theme-secondary-bg-color, rgba(30, 30, 30, 0.9));
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .settings-slider {
            width: 100%;
            margin: 10px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-id {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-item.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .shop-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .shop-category {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shop-category.active {
            background: var(--tg-theme-button-color, #ff6b6b);
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .shop-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .shop-item-price {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .tab-container {
            display: none;
        }

        .tab-container.active {
            display: block;
        }

        .tab-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--tg-theme-text-color, #ffffff);
            cursor: pointer;
            font-weight: 500;
            opacity: 0.7;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            opacity: 1;
            border-bottom: 2px solid var(--tg-theme-button-color, #ff6b6b);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--tg-theme-bg-color, #6a11cb);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 5px solid var(--tg-theme-button-color, #ff6b6b);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2.5rem;
            }

            .counter {
                font-size: 2.5rem;
            }

            .click-button {
                width: 140px;
                height: 140px;
                font-size: 1.4rem;
            }

            .container {
                padding: 30px 20px;
            }

            .message {
                font-size: 1.2rem;
            }

            .stats {
                flex-direction: column;
                gap: 15px;
            }

            .achievements-grid, .shop-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="settings-panel">
            <div class="settings-btn" id="settingsBtn">
                <i class="fas fa-cog"></i>
            </div>
        </div>

        <h1 class="title">Агния27</h1>
        <div class="counter" id="counter">0</div>
        <button class="click-button" id="clickButton">КЛИК</button>
        <div class="message" id="message">Нажми на кнопку!</div>

        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="clicksPerSecond">0</div>
                <div class="stat-label">Кликов/сек</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxCPS">0</div>
                <div class="stat-label">Макс. CPS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalClicks">0</div>
                <div class="stat-label">Всего кликов</div>
            </div>
        </div>

        <div class="auto-clicker">
            <div class="stat-label">Авто-кликер: <span id="autoClickerLevel">0</span> ур.</div>
            <button class="upgrade" id="upgradeAutoClicker">Улучшить (50 кликов)</button>
        </div>

        <div class="upgrades">
            <button class="upgrade" id="upgradeMultiplier">Умножитель x2 (100 кликов)</button>
            <button class="upgrade" id="upgradeClickPower">Сила клика +1 (30 кликов)</button>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="main">Основное</button>
            <button class="tab-button" data-tab="upgrades">Улучшения</button>
            <button class="tab-button" data-tab="shop">Магазин</button>
            <button class="tab-button" data-tab="achievements">Достижения</button>
        </div>

        <div class="tab-container active" id="tab-main">
            <!-- Основной контент уже на странице -->
        </div>

        <div class="tab-container" id="tab-upgrades">
            <div class="upgrades-grid">
                <button class="upgrade" data-upgrade="multiplier">Умножитель x2 (100 кликов)</button>
                <button class="upgrade" data-upgrade="clickPower">Сила клика +1 (30 кликов)</button>
                <button class="upgrade" data-upgrade="autoClicker">Автокликер (50 кликов)</button>
                <button class="upgrade" data-upgrade="criticalChance">Шанс крита +5% (200 кликов)</button>
                <button class="upgrade" data-upgrade="criticalMultiplier">Множитель крита x2 (300 кликов)</button>
            </div>
        </div>

        <div class="tab-container" id="tab-shop">
            <div class="shop-categories">
                <div class="shop-category active" data-category="boosters">Бусты</div>
                <div class="shop-category" data-category="skins">Скины</div>
                <div class="shop-category" data-category="special">Особые</div>
            </div>
            <div class="shop-items" id="shop-items">
                <!-- Товары будут добавляться динамически -->
            </div>
        </div>

        <div class="tab-container" id="tab-achievements">
            <div class="achievements-grid" id="achievements-grid">
                <!-- Достижения будут добавляться динамически -->
            </div>
        </div>
    </div>

    <div class="achievement" id="achievement">Достижение разблокировано!</div>

    <!-- Модальное окно настроек -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeSettings">&times;</button>
            <h2 class="modal-title">Настройки</h2>

            <div class="user-info">
                <img src="" alt="Аватар" class="user-avatar" id="userAvatar">
                <div class="user-details">
                    <div class="user-name" id="userName">Пользователь</div>
                    <div class="user-id" id="userId">ID: </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Звук</h3>
                <label class="settings-label">
                    <input type="checkbox" id="soundEnabled" checked> Включить звуки
                </label>
                <label class="settings-label">
                    <input type="checkbox" id="musicEnabled" checked> Фоновая музыка
                </label>
                <label class="settings-label">Громкость:</label>
                <input type="range" min="0" max="100" value="80" class="settings-slider" id="volumeSlider">
            </div>

            <div class="settings-section">
                <h3>Внешний вид</h3>
                <label class="settings-label">
                    <input type="checkbox" id="darkTheme"> Темная тема
                </label>
                <label class="settings-label">
                    <input type="checkbox" id="particlesEnabled" checked> Частицы при кликах
                </label>
            </div>

            <div class="settings-section">
                <h3>Статистика</h3>
                <div class="stat-item">
                    <div class="stat-label">Всего кликов:</div>
                    <div class="stat-value" id="statsTotalClicks">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Макс. CPS:</div>
                    <div class="stat-value" id="statsMaxCPS">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Время игры:</div>
                    <div class="stat-value" id="statsPlayTime">0:00</div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Действия</h3>
                <button class="upgrade" id="exportData">Экспорт данных</button>
                <button class="upgrade" id="resetProgress">Сбросить прогресс</button>
            </div>
        </div>
    </div>

    <!-- Аудио элементы -->
    <audio id="clickSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>
    <audio id="achievementSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="upgradeSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" type="audio/mpeg">
    </audio>
    <audio id="backgroundMusic" loop preload="auto">
        <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Инициализация Telegram WebApp
        let tg = window.Telegram.WebApp;

        // Основные переменные игры
        let count = 0;
        let totalClicks = 0;
        let clicksInLastSecond = 0;
        let maxCPS = 0;
        let clickPower = 1;
        let multiplier = 1;
        let autoClickerLevel = 0;
        let criticalChance = 0;
        let criticalMultiplier = 2;
        let playTime = 0;
        let cpsInterval;
        let autoClickerInterval;
        let playTimeInterval;

        // Настройки по умолчанию
        let settings = {
            sound: true,
            music: true,
            volume: 0.8,
            darkTheme: false,
            particles: true
        };

        // Достижения
        let achievements = [
            { id: 'first_27', count: 27, title: 'Первые 27 кликов!', description: 'Наберите 27 кликов', icon: '🥇', unlocked: false },
            { id: 'hundred', count: 100, title: '100 кликов!', description: 'Наберите 100 кликов', icon: '🏆', unlocked: false },
            { id: 'five_hundred', count: 500, title: '500 кликов! Мастер клика!', description: 'Наберите 500 кликов', icon: '👑', unlocked: false },
            { id: 'speed_5', cps: 5, title: 'Скорость 5 кликов/сек!', description: 'Достигните скорости 5 кликов в секунду', icon: '⚡', unlocked: false },
            { id: 'speed_10', cps: 10, title: 'Невероятная скорость 10 кликов/сек!', description: 'Достигните скорости 10 кликов в секунду', icon: '🚀', unlocked: false },
            { id: 'first_upgrade', upgrade: true, title: 'Первое улучшение!', description: 'Купите первое улучшение', icon: '🛠️', unlocked: false },
            { id: 'max_multiplier', multiplier: 10, title: 'Максимальный множитель!', description: 'Достигните множителя x10', icon: '✨', unlocked: false }
        ];

        // Магазин
        let shopItems = {
            boosters: [
                { id: 'booster_30min', name: 'Буст x2 на 30 мин', price: 200, effect: { multiplier: 2 }, duration: 1800 },
                { id: 'booster_1h', name: 'Буст x2 на 1 час', price: 350, effect: { multiplier: 2 }, duration: 3600 },
                { id: 'booster_4h', name: 'Буст x3 на 4 часа', price: 800, effect: { multiplier: 3 }, duration: 14400 }
            ],
            skins: [
                { id: 'skin_gold', name: 'Золотая кнопка', price: 1000, effect: { skin: 'gold' } },
                { id: 'skin_diamond', name: 'Алмазная кнопка', price: 5000, effect: { skin: 'diamond' } }
            ],
            special: [
                { id: 'special_100clicks', name: 'Автоклик на 100 кликов', price: 1500, effect: { autoClick: 100 } },
                { id: 'special_mystery', name: 'Таинственный сундук', price: 3000, effect: { random: true } }
            ]
        };

        // Активные бусты
        let activeBoosters = [];

        // Элементы DOM
        const counterElement = document.getElementById('counter');
        const clickButton = document.getElementById('clickButton');
        const messageElement = document.getElementById('message');
        const cpsElement = document.getElementById('clipsPerSecond');
        const maxCPSElement = document.getElementById('maxCPS');
        const totalClicksElement = document.getElementById('totalClicks');
        const achievementElement = document.getElementById('achievement');
        const progressElement = document.getElementById('progress');
        const upgradeMultiplierBtn = document.getElementById('upgradeMultiplier');
        const upgradeClickPowerBtn = document.getElementById('upgradeClickPower');
        const upgradeAutoClickerBtn = document.getElementById('upgradeAutoClicker');
        const autoClickerLevelElement = document.getElementById('autoClickerLevel');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettings');
        const loadingElement = document.getElementById('loading');
        const userAvatarElement = document.getElementById('userAvatar');
        const userNameElement = document.getElementById('userName');
        const userIdElement = document.getElementById('userId');
        const soundEnabledCheckbox = document.getElementById('soundEnabled');
        const musicEnabledCheckbox = document.getElementById('musicEnabled');
        const volumeSlider = document.getElementById('volumeSlider');
        const darkThemeCheckbox = document.getElementById('darkTheme');
        const particlesCheckbox = document.getElementById('particlesEnabled');
        const statsTotalClicksElement = document.getElementById('statsTotalClicks');
        const statsMaxCPSElement = document.getElementById('statsMaxCPS');
        const statsPlayTimeElement = document.getElementById('statsPlayTime');
        const exportDataBtn = document.getElementById('exportData');
        const resetProgressBtn = document.getElementById('resetProgress');
        const achievementsGrid = document.getElementById('achievements-grid');
        const shopItemsContainer = document.getElementById('shop-items');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContainers = document.querySelectorAll('.tab-container');

        // Аудио элементы
        const clickSound = document.getElementById('clickSound');
        const achievementSound = document.getElementById('achievementSound');
        const upgradeSound = document.getElementById('upgradeSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // Сообщения, которые будут появляться при клике
        const messages = ["Агния", "27", "Агния27", "Агния, Агния!", "27 Агния", "Агния 27 27", "27 27 27!"];

        // Инициализация игры
        function initGame() {
            // Инициализация Telegram WebApp
            tg.expand();
            tg.enableClosingConfirmation();

            // Загрузка данных пользователя
            loadUserData();

            // Загрузка сохраненного прогресса
            loadGameProgress();

            // Настройка интервалов
            initCPS();
            initAutoClicker();
            initPlayTime();

            // Обновление интерфейса
            updateUI();

            // Настройка обработчиков событий
            setupEventListeners();

            // Загрузка достижений
            renderAchievements();

            // Загрузка магазина
            renderShopItems('boosters');

            // Скрытие экрана загрузки
            setTimeout(() => {
                loadingElement.style.opacity = '0';
                setTimeout(() => {
                    loadingElement.style.display = 'none';
                }, 500);
            }, 1000);
        }

        // Загрузка данных пользователя из Telegram
        function loadUserData() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                userNameElement.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Пользователь';
                userIdElement.textContent = `ID: ${user.id}`;

                if (user.photo_url) {
                    userAvatarElement.src = user.photo_url;
                } else {
                    userAvatarElement.style.display = 'none';
                }
            }
        }

        // Загрузка прогресса игры из Telegram Cloud Storage
        function loadGameProgress() {
            tg.CloudStorage.getKeys((error, keys) => {
                if (error) {
                    console.error('Ошибка загрузки прогресса:', error);
                    return;
                }

                if (keys && keys.length > 0) {
                    tg.CloudStorage.getItems(keys, (error, data) => {
                        if (error) {
                            console.error('Ошибка загрузки данных:', error);
                            return;
                        }

                        if (data) {
                            // Восстановление прогресса
                            if (data.count) count = parseInt(data.count);
                            if (data.totalClicks) totalClicks = parseInt(data.totalClicks);
                            if (data.clickPower) clickPower = parseInt(data.clickPower);
                            if (data.multiplier) multiplier = parseInt(data.multiplier);
                            if (data.autoClickerLevel) autoClickerLevel = parseInt(data.autoClickerLevel);
                            if (data.criticalChance) criticalChance = parseInt(data.criticalChance);
                            if (data.criticalMultiplier) criticalMultiplier = parseInt(data.criticalMultiplier);
                            if (data.maxCPS) maxCPS = parseInt(data.maxCPS);
                            if (data.playTime) playTime = parseInt(data.playTime);

                            // Восстановление настроек
                            if (data.settings) {
                                try {
                                    const savedSettings = JSON.parse(data.settings);
                                    settings = { ...settings, ...savedSettings };

                                    // Применение настроек
                                    soundEnabledCheckbox.checked = settings.sound;
                                    musicEnabledCheckbox.checked = settings.music;
                                    volumeSlider.value = settings.volume * 100;
                                    darkThemeCheckbox.checked = settings.darkTheme;
                                    particlesCheckbox.checked = settings.particles;

                                    // Применение темы
                                    if (settings.darkTheme) {
                                        document.body.classList.add('dark-theme');
                                    }

                                    // Применение громкости
                                    setVolume(settings.volume);

                                    // Включение/выключение музыки
                                    if (settings.music) {
                                        backgroundMusic.play().catch(e => console.log("Автовоспроизведение музыки заблокировано"));
                                    }
                                } catch (e) {
                                    console.error('Ошибка парсинга настроек:', e);
                                }
                            }

                            // Восстановление достижений
                            if (data.achievements) {
                                try {
                                    const savedAchievements = JSON.parse(data.achievements);
                                    achievements = achievements.map(ach => {
                                        const saved = savedAchievements.find(a => a.id === ach.id);
                                        return saved ? { ...ach, ...saved } : ach;
                                    });
                                } catch (e) {
                                    console.error('Ошибка парсинга достижений:', e);
                                }
                            }

                            updateUI();
                        }
                    });
                }
            });
        }

        // Сохранение прогресса игры в Telegram Cloud Storage
        function saveGameProgress() {
            const data = {
                count: count.toString(),
                totalClicks: totalClicks.toString(),
                clickPower: clickPower.toString(),
                multiplier: multiplier.toString(),
                autoClickerLevel: autoClickerLevel.toString(),
                criticalChance: criticalChance.toString(),
                criticalMultiplier: criticalMultiplier.toString(),
                maxCPS: maxCPS.toString(),
                playTime: playTime.toString(),
                settings: JSON.stringify(settings),
                achievements: JSON.stringify(achievements)
            };

            tg.CloudStorage.setItems(data, (error) => {
                if (error) {
                    console.error('Ошибка сохранения:', error);
                }
            });
        }

        // Инициализация подсчета кликов в секунду
        function initCPS() {
            let lastClicks = totalClicks;

            cpsInterval = setInterval(() => {
                clicksInLastSecond = totalClicks - lastClicks;
                lastClicks = totalClicks;

                if (clicksInLastSecond > maxCPS) {
                    maxCPS = clicksInLastSecond;
                }

                updateUI();
                checkAchievements();
            }, 1000);
        }

        // Инициализация автокликера
        function initAutoClicker() {
            if (autoClickerInterval) {
                clearInterval(autoClickerInterval);
            }

            if (autoClickerLevel > 0) {
                autoClickerInterval = setInterval(() => {
                    const autoClicks = autoClickerLevel;
                    addClicks(autoClicks);
                }, 1000);
            }
        }

        // Инициализация таймера игрового времени
        function initPlayTime() {
            playTimeInterval = setInterval(() => {
                playTime++;

                // Обновляем время в настройках каждую минуту
                if (playTime % 60 === 0) {
                    updateSettingsUI();
                }
            }, 1000);
        }

        // Добавление кликов
        function addClicks(amount) {
            // Проверка на критический удар
            let isCritical = false;
            if (Math.random() < criticalChance / 100) {
                amount *= criticalMultiplier;
                isCritical = true;
            }

            // Применение множителя
            const addedCount = Math.floor(amount * multiplier);
            count += addedCount;
            totalClicks += amount;

            // Обновление UI
            updateUI();

            // Сохранение прогресса
            saveGameProgress();

            // Визуальные эффекты
            if (isCritical) {
                showCriticalEffect(amount);
            } else {
                showClickEffect(amount);
            }

            // Воспроизведение звука
            playSound(clickSound);

            // Виброотклик
            tg.HapticFeedback.impactOccurred('light');
        }

        // Покупка улучшения
        function buyUpgrade(type, cost) {
            if (count >= cost) {
                count -= cost;

                switch (type) {
                    case 'multiplier':
                        multiplier *= 2;
                        break;
                    case 'clickPower':
                        clickPower += 1;
                        break;
                    case 'autoClicker':
                        autoClickerLevel += 1;
                        initAutoClicker();
                        break;
                    case 'criticalChance':
                        criticalChance += 5;
                        break;
                    case 'criticalMultiplier':
                        criticalMultiplier *= 2;
                        break;
                }

                // Воспроизведение звука
                playSound(upgradeSound);

                // Сохранение прогресса
                saveGameProgress();

                // Обновление UI
                updateUI();

                // Проверка достижений
                checkAchievements();

                return true;
            }

            return false;
        }

        // Покупка товара в магазине
        function buyShopItem(item) {
            if (count >= item.price) {
                count -= item.price;

                // Применение эффекта товара
                if (item.effect.multiplier) {
                    // Активация буста
                    const booster = {
                        effect: item.effect,
                        expires: Date.now() + (item.duration * 1000)
                    };
                    activeBoosters.push(booster);
                    applyBoosters();

                    // Таймер для удаления буста
                    setTimeout(() => {
                        activeBoosters = activeBoosters.filter(b => b !== booster);
                        applyBoosters();
                        updateUI();
                    }, item.duration * 1000);
                }

                // Сохранение прогресса
                saveGameProgress();

                // Обновление UI
                updateUI();

                return true;
            }

            return false;
        }

        // Применение активных бустов
        function applyBoosters() {
            let totalMultiplier = 1;

            activeBoosters.forEach(booster => {
                totalMultiplier *= booster.effect.multiplier;
            });

            multiplier = totalMultiplier;
        }

        // Проверка достижений
        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!achievement.unlocked) {
                    let unlocked = false;

                    if (achievement.count && totalClicks >= achievement.count) {
                        unlocked = true;
                    }

                    if (achievement.cps && maxCPS >= achievement.cps) {
                        unlocked = true;
                    }

                    if (achievement.upgrade && autoClickerLevel > 0) {
                        unlocked = true;
                    }

                    if (achievement.multiplier && multiplier >= achievement.multiplier) {
                        unlocked = true;
                    }

                    if (unlocked) {
                        achievement.unlocked = true;
                        showAchievement(achievement);
                        saveGameProgress();
                    }
                }
            });
        }

        // Показ достижения
        function showAchievement(achievement) {
            achievementElement.textContent = `${achievement.icon} ${achievement.title}`;
            achievementElement.classList.add('show');

            // Воспроизведение звука
            playSound(achievementSound);

            // Виброотклик
            tg.HapticFeedback.notificationOccurred('success');

            setTimeout(() => {
                achievementElement.classList.remove('show');
            }, 3000);
        }

        // Отображение эффекта клика
        function showClickEffect(amount) {
            if (!settings.particles) return;

            const effect = document.createElement('div');
            effect.className = 'floating';
            effect.textContent = `+${amount}`;
            effect.style.left = `${Math.random() * 80 + 10}%`;
            effect.style.color = '#ffffff';

            document.body.appendChild(effect);

            setTimeout(() => {
                document.body.removeChild(effect);
            }, 3000);
        }

        // Отображение эффекта критического удара
        function showCriticalEffect(amount) {
            if (!settings.particles) return;

            const effect = document.createElement('div');
            effect.className = 'floating';
            effect.textContent = `КРИТ! +${amount}`;
            effect.style.left = `${Math.random() * 80 + 10}%`;
            effect.style.color = '#ffeb3b';
            effect.style.fontSize = '1.5rem';

            document.body.appendChild(effect);

            // Виброотклик
            tg.HapticFeedback.impactOccurred('heavy');

            setTimeout(() => {
                document.body.removeChild(effect);
            }, 3000);
        }

        // Воспроизведение звука
        function playSound(soundElement) {
            if (!settings.sound) return;

            soundElement.currentTime = 0;
            soundElement.volume = settings.volume;
            soundElement.play().catch(e => console.log("Воспроизведение звука заблокировано"));
        }

        // Установка громкости
        function setVolume(volume) {
            settings.volume = volume;

            clickSound.volume = volume;
            achievementSound.volume = volume;
            upgradeSound.volume = volume;
            backgroundMusic.volume = volume * 0.7;
        }

        // Обновление интерфейса
        function updateUI() {
            // Обновление счетчиков
            counterElement.textContent = formatNumber(count);
            cpsElement.textContent = clicksInLastSecond;
            maxCPSElement.textContent = maxCPS;
            totalClicksElement.textContent = formatNumber(totalClicks);
            autoClickerLevelElement.textContent = autoClickerLevel;

            // Обновление прогресс-бара
            const nextUpgrade = Math.max(50, 100, 30);
            const progress = Math.min((count / nextUpgrade) * 100, 100);
            progressElement.style.width = `${progress}%`;

            // Обновление кнопок улучшений
            upgradeMultiplierBtn.disabled = count < 100;
            upgradeClickPowerBtn.disabled = count < 30;
            upgradeAutoClickerBtn.disabled = count < 50;

            // Обновление текста кнопок улучшений
            upgradeMultiplierBtn.textContent = `Умножитель x${multiplier * 2} (${formatNumber(100 * Math.pow(2, Math.log2(multiplier)))})`;
            upgradeClickPowerBtn.textContent = `Сила клика +1 (${formatNumber(30 + clickPower * 10)})`;
            upgradeAutoClickerBtn.textContent = `Улучшить (${formatNumber(50 + autoClickerLevel * 50)})`;

            // Случайное сообщение
            if (clicksInLastSecond > 0 && Math.random() < 0.1) {
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                messageElement.textContent = randomMessage;

                setTimeout(() => {
                    messageElement.textContent = '';
                }, 2000);
            }
        }

        // Обновление UI настроек
        function updateSettingsUI() {
            statsTotalClicksElement.textContent = formatNumber(totalClicks);
            statsMaxCPSElement.textContent = maxCPS;

            const minutes = Math.floor(playTime / 60);
            const seconds = playTime % 60;
            statsPlayTimeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Отображение достижений
        function renderAchievements() {
            achievementsGrid.innerHTML = '';

            achievements.forEach(achievement => {
                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement-item ${achievement.unlocked ? '' : 'locked'}`;

                achievementElement.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                `;

                achievementsGrid.appendChild(achievementElement);
            });
        }

        // Отображение товаров магазина
        function renderShopItems(category) {
            shopItemsContainer.innerHTML = '';

            const items = shopItems[category];

            items.forEach(item => {
                const itemElement = document.createElement('button');
                itemElement.className = 'shop-item';
                itemElement.disabled = count < item.price;

                itemElement.innerHTML = `
                    <div class="shop-item-title">${item.name}</div>
                    <div class="shop-item-price">${formatNumber(item.price)} кликов</div>
                `;

                itemElement.addEventListener('click', () => {
                    if (buyShopItem(item)) {
                        renderShopItems(category);
                    }
                });

                shopItemsContainer.appendChild(itemElement);
            });
        }

        // Форматирование чисел (1000 -> 1K)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Основной клик
            clickButton.addEventListener('click', () => {
                addClicks(clickPower);
                clickButton.classList.add('pulse');
                setTimeout(() => {
                    clickButton.classList.remove('pulse');
                }, 300);
            });

            // Улучшения
            upgradeMultiplierBtn.addEventListener('click', () => {
                const cost = 100 * Math.pow(2, Math.log2(multiplier));
                if (buyUpgrade('multiplier', cost)) {
                    updateUI();
                }
            });

            upgradeClickPowerBtn.addEventListener('click', () => {
                const cost = 30 + clickPower * 10;
                if (buyUpgrade('clickPower', cost)) {
                    updateUI();
                }
            });

            upgradeAutoClickerBtn.addEventListener('click', () => {
                const cost = 50 + autoClickerLevel * 50;
                if (buyUpgrade('autoClicker', cost)) {
                    updateUI();
                }
            });

            // Кнопка настроек
            settingsBtn.addEventListener('click', () => {
                updateSettingsUI();
                settingsModal.classList.add('active');
            });

            closeSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });

            // Настройки звука
            soundEnabledCheckbox.addEventListener('change', () => {
                settings.sound = soundEnabledCheckbox.checked;
                saveGameProgress();
            });

            musicEnabledCheckbox.addEventListener('change', () => {
                settings.music = musicEnabledCheckbox.checked;

                if (settings.music) {
                    backgroundMusic.play().catch(e => console.log("Автовоспроизведение музыки заблокировано"));
                } else {
                    backgroundMusic.pause();
                }

                saveGameProgress();
            });

            volumeSlider.addEventListener('input', () => {
                const volume = volumeSlider.value / 100;
                setVolume(volume);
                settings.volume = volume;
                saveGameProgress();
            });

            // Настройки темы
            darkThemeCheckbox.addEventListener('change', () => {
                settings.darkTheme = darkThemeCheckbox.checked;

                if (settings.darkTheme) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }

                saveGameProgress();
            });

            particlesCheckbox.addEventListener('change', () => {
                settings.particles = particlesCheckbox.checked;
                saveGameProgress();
            });

            // Действия
            exportDataBtn.addEventListener('click', () => {
                const data = JSON.stringify({
                    count,
                    totalClicks,
                    clickPower,
                    multiplier,
                    autoClickerLevel,
                    criticalChance,
                    criticalMultiplier,
                    maxCPS,
                    playTime,
                    achievements: achievements.filter(a => a.unlocked).map(a => a.title)
                }, null, 2);

                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'agnia27_save.json';
                a.click();

                URL.revokeObjectURL(url);
            });

            resetProgressBtn.addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите сбросить весь прогресс? Это действие нельзя отменить.')) {
                    // Сброс прогресса
                    count = 0;
                    totalClicks = 0;
                    clickPower = 1;
                    multiplier = 1;
                    autoClickerLevel = 0;
                    criticalChance = 0;
                    criticalMultiplier = 2;
                    maxCPS = 0;
                    playTime = 0;

                    // Сброс достижений
                    achievements.forEach(a => a.unlocked = false);

                    // Перезапуск автокликера
                    initAutoClicker();

                    // Обновление UI
                    updateUI();
                    renderAchievements();

                    // Сохранение
                    saveGameProgress();

                    // Уведомление
                    tg.showPopup({
                        title: 'Прогресс сброшен',
                        message: 'Все данные были успешно сброшены.',
                        buttons: [{ type: 'ok' }]
                    });
                }
            });

            // Переключение вкладок
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    // Активация кнопки
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // Активация вкладки
                    tabContainers.forEach(tab => tab.classList.remove('active'));
                    document.getElementById(`tab-${tabId}`).classList.add('active');

                    // Если открыта вкладка магазина, загружаем товары
                    if (tabId === 'shop') {
                        const activeCategory = document.querySelector('.shop-category.active').getAttribute('data-category');
                        renderShopItems(activeCategory);
                    }
                });
            });

            // Категории магазина
            document.querySelectorAll('.shop-category').forEach(category => {
                category.addEventListener('click', () => {
                    document.querySelectorAll('.shop-category').forEach(c => c.classList.remove('active'));
                    category.classList.add('active');

                    const categoryName = category.getAttribute('data-category');
                    renderShopItems(categoryName);
                });
            });

            // Улучшения во вкладке
            document.querySelectorAll('.upgrade[data-upgrade]').forEach(upgrade => {
                upgrade.addEventListener('click', () => {
                    const type = upgrade.getAttribute('data-upgrade');
                    let cost = 0;

                    switch (type) {
                        case 'multiplier':
                            cost = 100 * Math.pow(2, Math.log2(multiplier));
                            break;
                        case 'clickPower':
                            cost = 30 + clickPower * 10;
                            break;
                        case 'autoClicker':
                            cost = 50 + autoClickerLevel * 50;
                            break;
                        case 'criticalChance':
                            cost = 200;
                            break;
                        case 'criticalMultiplier':
                            cost = 300;
                            break;
                    }

                    if (buyUpgrade(type, cost)) {
                        updateUI();
                    }
                });
            });
        }

        // Инициализация игры при загрузке
        document.addEventListener('DOMContentLoaded', initGame);

        // Обработка видимости страницы (пауза музыки при скрытии)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                backgroundMusic.pause();
            } else if (settings.music) {
                backgroundMusic.play().catch(e => console.log("Автовоспроизведение музыки заблокировано"));
            }
        });
    </script>
</body>
</html>